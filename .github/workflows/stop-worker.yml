name: Stop GPU Worker (7 PM PKT)

on:
  schedule:
    # 7 PM Pakistan Time = 2 PM UTC (PKT is UTC+5)
    - cron: '0 14 * * 1-5'  # Mon-Fri at 2:00 PM UTC
  workflow_dispatch:  # Manual trigger

env:
  AWS_REGION: us-east-1

jobs:
  stop-worker:
    name: Stop GPU Worker
    runs-on: ubuntu-latest
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Stop ECS Worker Service
      run: |
        echo "üõë Stopping GPU worker at $(date)"
        
        # Scale down worker service to 0
        aws ecs update-service \
          --cluster clip-it-cluster \
          --service clip-it-gpu-worker-service \
          --desired-count 0
        
        echo "‚è∏Ô∏è Worker service scaled to 0"

    - name: Scale down GPU ASG
      run: |
        echo "üìâ Scaling down GPU ASG..."
        
        # Find and scale down the GPU ASG
        ASG_NAME=$(aws autoscaling describe-auto-scaling-groups \
          --query "AutoScalingGroups[?contains(AutoScalingGroupName, 'GPUWorker')].AutoScalingGroupName" \
          --output text)
        
        if [ ! -z "$ASG_NAME" ]; then
          echo "üìâ Scaling down ASG: $ASG_NAME"
          aws autoscaling set-desired-capacity \
            --auto-scaling-group-name "$ASG_NAME" \
            --desired-capacity 0
        fi
        
        echo "‚úÖ GPU worker stopped for the night! üí∞ Saving costs..."
