name: Start GPU Worker (9 AM PKT)

on:
  schedule:
    # 9 AM Pakistan Time = 4 AM UTC (PKT is UTC+5)
    - cron: '0 4 * * 1-5'  # Mon-Fri at 4:00 AM UTC
  workflow_dispatch:  # Manual trigger

env:
  AWS_REGION: us-east-1

jobs:
  start-worker:
    name: Start GPU Worker
    runs-on: ubuntu-latest
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Scale up GPU ASG
      run: |
        echo "ðŸš€ Starting GPU worker at $(date)"
        
        # Find and scale up the GPU ASG
        ASG_NAME=$(aws autoscaling describe-auto-scaling-groups \
          --query "AutoScalingGroups[?contains(AutoScalingGroupName, 'GPUWorker')].AutoScalingGroupName" \
          --output text)
        
        if [ ! -z "$ASG_NAME" ]; then
          echo "ðŸ“ˆ Scaling up ASG: $ASG_NAME"
          aws autoscaling set-desired-capacity \
            --auto-scaling-group-name "$ASG_NAME" \
            --desired-capacity 1
        fi

    - name: Start ECS Worker Service
      run: |
        echo "ðŸ”§ Starting ECS worker service..."
        
        aws ecs update-service \
          --cluster clip-it-cluster \
          --service clip-it-gpu-worker-service \
          --desired-count 1
        
        echo "âœ… GPU worker started for the day!"
